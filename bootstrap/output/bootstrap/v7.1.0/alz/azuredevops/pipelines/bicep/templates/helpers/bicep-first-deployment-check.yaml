---
parameters:
  - name: serviceConnection
    type: string

steps:
  - task: AzurePowerShell@5
    displayName: 'Check for First Deployment'
    inputs:
      azureSubscription: $${{ parameters.serviceConnection }}
      pwsh: true
      azurePowerShellVersion: LatestVersion
      ScriptType: "InlineScript"
      Inline: |
        $intRootMgId = "$(MANAGEMENT_GROUP_ID_PREFIX)$(INTERMEDIATE_ROOT_MANAGEMENT_GROUP_ID)$(MANAGEMENT_GROUP_ID_POSTFIX)"

        $managementGroup = Get-AzManagementGroup -GroupName $intRootMgId -Expand

        $firstDeployment = $true

        if($managementGroup -eq $null) {
          Write-Warning "Cannot find the $intRootMgId Management Group, so assuming this is the first deployment."
        } else {
          Write-Host "Found the $intRootMgId Management Group."
          $children = $managementGroup.Children | Where-Object { $_.Type -eq "Microsoft.Management/managementGroups" }
          if($children.Count -gt 0) {
            Write-Host "The $intRootMgId Management Group has child management groups, so this is NOT the first deployment."
            $firstDeployment = $false
          } else {
            Write-Host "The $intRootMgId Management Group has NO child management groups, so assuming this is the first deployment."
          }
        }

        Write-Host "##vso[task.setvariable variable=FIRST_DEPLOYMENT;]$firstDeployment"
